# PySD — Python Structural Design Library

PySD is a Python library for structural modeling with a modern, container-based architecture, rich validation, and clean I/O. It’s designed so adding new statement types is fast, consistent, and IDE-friendly.

## Highlights

- Container-based model: each statement type has a typed container.
- Auto-registration: new statements are auto-discovered at import time.
- Validation: instance-, container-, and model-level rules.
- Simple API: create `SD_BASE`, add statements, write `.inp`.
- IDE support: `.pyi` stubs provide completions and signatures.

## Installation

Using uv (recommended):
```powershell
uv venv
uv pip install -e .
```

Using pip:
```powershell
python -m venv .venv
.venv\Scripts\Activate.ps1
pip install -e .
```

Run tests:
```powershell
pytest -q
```

## Quick Start

This example mirrors the structure in `main.py` and shows the typical flow.

```python
from pysd.statements import (
    DESEC, RFILE, SHAXE, LOADC, GRECO, FILST, BASCO, LoadCase,
    RETYP, DECAS, RELOC, EXECD, LORES, CMPEC, SHSEC, XTFIL,
    TABLE, RMPEC, Cases, HEADING, DEPAR
)
from pysd import SD_BASE, ValidationLevel

# 1) Create a model (choose validation level)
model = SD_BASE(validation_level=ValidationLevel.NORMAL, cross_object_validation=True)

# 2) Basic metadata
model.add(FILST(name="aquapod", vers="1.0", date="14.aug-2025", resp="som"))
model.add(RFILE(pre=r"C:\path\to\Analyse_file", fnm="R1", suf="SIN", typ="SHE"))

# 3) Sections and axes
model.add(SHSEC(pa="PLATE", elset=3, hs=(1,4)))
model.add(SHAXE(pa="PLATE", x1=(1,0,0), x2=(0,1,0), x3=(0,0,1)))

# 4) Loads
model.add([
    LOADC(run_number=1, alc=(1,6), olc=(201,206), comment="Equilibrium load case"),
    LOADC(run_number=1, alc=(11,16), olc=(101,106)),
    LOADC(table=True),
    LOADC(pri=True),
])
model.add(LORES(pri_alc=True))  # -> LORES PRI=ALC
model.add(LORES(sin=True))      # -> LORES SIN=

# 5) BASCO + GRECO
for i in range(6):
    model.add(BASCO(id=211+i, load_cases=[LoadCase(lc_type='OLC', lc_numb=101+i, lc_fact=1)]))
model.add(GRECO(id='A', bas=Cases(ranges=[(211, 216)])))  # references BASCO ids

# 6) Materials
model.add(DEPAR(n_lay=10, d_sig=10.0, d_cod="NS"))
model.add(CMPEC(id=1, gr="B35"))
model.add(RMPEC(id=1, gr="500"))

# 7) Reinforcement types (RETYP) and locations (RELOC)
model.add(HEADING(statement="Reinforcement types",
                  description="Defining reinforcement types used in the model",
                  comment="Generated by PySD"))
model.add(RETYP(id=1, mp=1, ar=753.0E-6, c2=0.055, th=0.014, di=0.012, nr=1, lb="1.0D12_c150"))
model.add(RETYP(id=2, mp=1, ar=753.0E-6, os=0.0, th=0.014, di=0.012, nr=1, lb="1.0D12_c150"))
model.add(RELOC(id="X12", pa="PLATE", rt=1, fa=1, al=0))

# 8) Design and extraction
model.add(DESEC(pa="PLATE"))
model.add(DECAS(ls='ULS', bas=(101,102), greco='A'))
model.add(XTFIL(fn="AquaPod_09", pa="PLATE", fs=(1,9999), hs=(1,99)))
model.add(TABLE(tab="GE"))
model.add(EXECD(dm='V'))

# 9) Write the input file
model.write("output.inp")
```

Notes:
- You can set a statement’s `comment` and it’ll be appended as `% <comment>` automatically.
- Containers are available dynamically: e.g., `model.retyp`, `model.basco`, `model.xtfil`.
- `ValidationLevel`: DISABLED | NORMAL | STRICT.

## Working with Containers

Every statement is stored in a container (dynamic attributes on `SD_BASE`):

```python
# Add multiple statements at once
model.add([RETYP(id=3, mp=1, ar=2.0e-3), RETYP(id=4, mp=1, ar=1.5e-3)])

# Inspect container contents
print(len(model.retyp))         # number of items
print(model.retyp.get_ids())    # list of ids
print(model.retyp.contains(3))  # True (IDs normalized for matching)
for item in model.retyp:
    print(item.input)           # raw input line(s)
```

## Validation

- Instance-level: enforced by Pydantic and statement-specific checks.
- Container-level: uniqueness, consistency checks when items are added.
- Model-level: cross-references (e.g., RELOC → SRTYP, SRTYP → RMPEC).

Triggered:
- Immediately if you call `model.add(..., validation=True)`.
- After model build (deferred) via `model.write(...)` or `model.validator.finalize_model_and_validation()`.

If validation fails:
- Raises `ValueError("Model validation failed:\n ...")` with detailed codes/messages.

## Adding a New Statement (Short Version)

Most of the boilerplate is gone. Add your statement in 3 steps:

1) Create a class in `src/pysd/statements/<name>.py` that subclasses `StatementBase`:

```python
from pydantic import Field
from .statement_base import StatementBase, StringBuilderHelper

class MYNEWSTATEMENT(StatementBase):
    id: int = Field(..., description="Unique id")
    req: str = Field(..., description="Required field")
    opt: int | None = Field(None, description="Optional field")

    @property
    def identifier(self) -> str:
        return str(self.id)

    def _build_input_string(self) -> str:
        b = StringBuilderHelper(self.statement_name)
        b.add_param("ID", self.id)
        b.add_param("REQ", self.req)
        b.add_param("OPT", self.opt, skip_if=None)
        return b.input
```

2) Export it in the statements aggregator to trigger auto-registration:
- Add a single import + `__all__` entry in `src/pysd/statements/__init__.py`:
```python
from .mynewstatement import MYNEWSTATEMENT
__all__.append("MYNEWSTATEMENT")
```
This eager import ensures `StatementBase.__init_subclass__` registers it. No edits needed in `ContainerFactory`.

3) (Optional) Add validation rules:
- Put rules in `src/pysd/validation/rules/mynewstatement_rules.py`.
- Use decorators `@instance_rule('MYNEWSTATEMENT')`, `@container_rule('MYNEWSTATEMENT')`, `@model_rule('MYNEWSTATEMENT')`.
- Make sure rules are imported by the validation system (most projects import all rules at package init; if you prefer explicit lists, add it there).

That’s it—your statement will have a container accessible via `model.mynewstatement`.

## Tips

- Comments: set `comment="..."` on any statement; it’s appended as `% ...` automatically.
- Emojis in headings: `HEADING` chooses an emoji by content; override with `emoji="..."` if you want a specific one.
- IDs: containers normalize IDs for matching (e.g., `"1"`, `1`, and `1.0` will match the same item when it makes sense).

## Development

- Run tests:
```powershell
pytest -q
```

- Format, lint (if configured in your environment):
```powershell
ruff check . ; ruff format .
```

- Example script:
```powershell
python -m pysd.main
```

---

For contributors/agents: see [AGENT_INSTRUCTIONS.md](./AGENT_INSTRUCTIONS.md) for project conventions and do’s/don’ts.
